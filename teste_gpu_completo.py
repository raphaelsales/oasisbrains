#!/usr/bin/env python3
"""
<<<<<<< HEAD
TESTE COMPLETO DE GPU - ALZHEIMER PIPELINE
Verifica capacidade e performance da GPU para processamento
"""

import time
import numpy as np
from typing import Tuple

# Cores para output colorido
=======
üß™ TESTE COMPLETO DE GPU vs CPU
Baseado em: https://saturncloud.io/blog/how-to-check-whether-your-code-is-running-on-the-gpu-or-cpu/

Este script testa e compara performance GPU vs CPU com indicadores visuais claros.
Compat√≠vel com NVIDIA RTX A4000 + Ubuntu 24.04 + CUDA 12.9
"""

import time
import sys
import numpy as np
from typing import Tuple, Optional

# Cores para output
>>>>>>> 3f8bd3ee87 (Add new processing scripts and documentation)
class Colors:
    GREEN = '\033[92m'
    RED = '\033[91m'
    BLUE = '\033[94m'
    YELLOW = '\033[93m'
    PURPLE = '\033[95m'
    CYAN = '\033[96m'
    WHITE = '\033[97m'
    BOLD = '\033[1m'
    END = '\033[0m'

def print_header(title: str):
<<<<<<< HEAD
    """Imprime cabe√ßalho formatado"""
    print(f"\n{Colors.BOLD}{Colors.WHITE}{title}{Colors.END}")
    print("=" * len(title))

def print_status(device: str, status: str, details: str = ""):
    """Imprime status com cores"""
    if "GPU" in device:
        icon = "GPU"
    elif "CPU" in device:
        icon = "CPU"
    else:
        icon = "SYS"
    
    color = Colors.GREEN if "OK" in status or "FUNCIONANDO" in status or "DETECTADA" in status or "DISPON√çVEL" in status else Colors.RED
    print(f"  {icon} {device}: {color}{status}{Colors.END} {details}")

def test_gpu_availability():
    """Testa disponibilidade e capacidade da GPU"""
    print_header("TESTE DE GPU - CAPACIDADE E DISPONIBILIDADE")
    
    # Testar CuPy
    try:
        import cupy as cp
        print_status("CuPy", "IMPORTADO", "Biblioteca GPU dispon√≠vel")
        
        # Teste b√°sico
=======
    """Imprime cabe√ßalho estilizado"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.WHITE}üöÄ {title}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")

def print_status(device: str, status: str, details: str = ""):
    """Imprime status do dispositivo"""
    if "GPU" in device:
        icon = "‚ö°"
        color = Colors.GREEN
    else:
        icon = "üñ•Ô∏è"
        color = Colors.BLUE
    
    print(f"{color}{icon} {device}: {status}{Colors.END}")
    if details:
        print(f"   {Colors.WHITE}‚îî‚îÄ {details}{Colors.END}")

def test_gpu_availability():
    """Testa disponibilidade e capacidades da GPU"""
    print_header("DIAGN√ìSTICO DE GPU")
    
    try:
        import cupy as cp
        print_status("CuPy", "‚úÖ IMPORTADO", "Biblioteca GPU dispon√≠vel")
        
        # Teste b√°sico de cria√ß√£o de array
>>>>>>> 3f8bd3ee87 (Add new processing scripts and documentation)
        try:
            start_time = time.time()
            test_array = cp.array([1, 2, 3, 4, 5])
            result = cp.sum(test_array)
            end_time = time.time()
<<<<<<< HEAD
            print_status("GPU", "FUNCIONANDO", f"Teste b√°sico OK (resultado: {result}, tempo: {end_time-start_time:.4f}s)")
=======
            
            print_status("GPU", "‚úÖ FUNCIONANDO", f"Teste b√°sico OK (resultado: {result}, tempo: {end_time-start_time:.4f}s)")
>>>>>>> 3f8bd3ee87 (Add new processing scripts and documentation)
            
            # Informa√ß√µes do dispositivo
            try:
                device_id = cp.cuda.device.get_device_id()
                device_props = cp.cuda.runtime.getDeviceProperties(device_id)
                device_name = device_props['name'].decode()
                
                memory_info = cp.cuda.runtime.memGetInfo()
<<<<<<< HEAD
                free_mem = memory_info[0] / 1024**3  # GB
                total_mem = memory_info[1] / 1024**3  # GB
                
                print_status("GPU Info", "DETECTADA", f"{device_name}")
                print_status("GPU Mem√≥ria", "DISPON√çVEL", f"{free_mem:.1f}GB livre de {total_mem:.1f}GB total")
                
                return True, cp
                
            except Exception as e:
                print_status("GPU Info", "ERRO", f"N√£o foi poss√≠vel obter informa√ß√µes: {str(e)[:50]}...")
                return True, cp
                
        except Exception as e:
            print_status("GPU", "FALHA", f"Erro no teste b√°sico: {str(e)[:50]}...")
            return False, None
            
    except ImportError:
        print_status("CuPy", "N√ÉO INSTALADO", "pip install cupy-cuda12x")
        return False, None

def performance_test_cpu(size: int = 5000) -> Tuple[float, float]:
    """Teste de performance na CPU"""
    print(f"\n{Colors.BLUE}TESTE CPU - Matriz {size}x{size}{Colors.END}")
    
    # Opera√ß√µes com NumPy (CPU)
    start_time = time.time()
    
    # Criar matrizes
=======
                total_mem = memory_info[1] / 1024**3
                free_mem = memory_info[0] / 1024**3
                
                print_status("GPU Info", "‚úÖ DETECTADA", f"{device_name}")
                print_status("GPU Mem√≥ria", "‚úÖ DISPON√çVEL", f"{free_mem:.1f}GB livre de {total_mem:.1f}GB total")
                
                return True, cp, device_name
                
            except Exception as e:
                print_status("GPU Info", "‚ùå ERRO", f"N√£o foi poss√≠vel obter informa√ß√µes: {str(e)[:50]}...")
                return False, None, "GPU gen√©rica"
                
        except Exception as e:
            print_status("GPU", "‚ùå FALHA", f"Erro no teste b√°sico: {str(e)[:50]}...")
            return False, None, "N/A"
            
    except ImportError:
        print_status("CuPy", "‚ùå N√ÉO INSTALADO", "pip install cupy-cuda12x")
        return False, None, "N/A"

def performance_test_cpu(size: int = 5000) -> Tuple[float, float]:
    """Teste de performance CPU"""
    print(f"\n{Colors.BLUE}üñ•Ô∏è  TESTE CPU - Matriz {size}x{size}{Colors.END}")
    
    start_time = time.time()
    
    # Opera√ß√µes NumPy (CPU)
>>>>>>> 3f8bd3ee87 (Add new processing scripts and documentation)
    a = np.random.random((size, size)).astype(np.float32)
    b = np.random.random((size, size)).astype(np.float32)
    
    # Multiplica√ß√£o de matrizes
    c = np.dot(a, b)
    
    # Opera√ß√µes estat√≠sticas
    mean_val = np.mean(c)
    std_val = np.std(c)
<<<<<<< HEAD
    
    cpu_time = time.time() - start_time
    
    print(f"   Resultado: m√©dia={mean_val:.4f}, std={std_val:.4f}")
    print(f"   Tempo CPU: {Colors.BOLD}{cpu_time:.4f} segundos{Colors.END}")
=======
    sum_val = np.sum(c)
    
    end_time = time.time()
    cpu_time = end_time - start_time
    
    print(f"   üìä Resultado: m√©dia={mean_val:.4f}, std={std_val:.4f}")
    print(f"   ‚è±Ô∏è  Tempo CPU: {Colors.BOLD}{cpu_time:.4f} segundos{Colors.END}")
>>>>>>> 3f8bd3ee87 (Add new processing scripts and documentation)
    
    return cpu_time, mean_val

def performance_test_gpu(cp, size: int = 5000) -> Tuple[float, float]:
<<<<<<< HEAD
    """Teste de performance na GPU"""
    print(f"\n{Colors.GREEN}TESTE GPU - Matriz {size}x{size}{Colors.END}")
    
    try:
        # Opera√ß√µes com CuPy (GPU)
        start_time = time.time()
        
        # Criar matrizes na GPU
        a = cp.random.random((size, size), dtype=cp.float32)
        b = cp.random.random((size, size), dtype=cp.float32)
        
        # Multiplica√ß√£o de matrizes
        c = cp.dot(a, b)
        
        # Opera√ß√µes estat√≠sticas
        mean_val = float(cp.mean(c))
        std_val = float(cp.std(c))
        
        # Sincronizar para medir tempo correto
        cp.cuda.Stream.null.synchronize()
        
        gpu_time = time.time() - start_time
        
        print(f"   Resultado: m√©dia={mean_val:.4f}, std={std_val:.4f}")
        print(f"   Tempo GPU: {Colors.BOLD}{gpu_time:.4f} segundos{Colors.END}")
        
        return gpu_time, mean_val
        
    except Exception as e:
        print_status("GPU Performance", "ERRO", str(e)[:50])
        return float('inf'), 0.0

def compare_performance(cpu_time: float, gpu_time: float):
    """Compara performance entre CPU e GPU"""
    print(f"\n{Colors.CYAN}COMPARA√á√ÉO DE PERFORMANCE{Colors.END}")
    print("-" * 30)
    
    print(f"{Colors.BLUE}CPU: {cpu_time:.4f} segundos{Colors.END}")
    print(f"{Colors.GREEN}GPU: {gpu_time:.4f} segundos{Colors.END}")
    
    if gpu_time > 0 and cpu_time > 0:
        speedup = cpu_time / gpu_time
        if speedup > 1:
            print(f"\n{Colors.BOLD}{Colors.GREEN}GPU √© {speedup:.2f}x MAIS R√ÅPIDO!{Colors.END}")
        else:
            print(f"\n{Colors.YELLOW}CPU foi {1/speedup:.2f}x mais r√°pido (matriz pequena demais ou overhead GPU){Colors.END}")
    else:
        print(f"\n{Colors.RED}N√£o foi poss√≠vel calcular speedup{Colors.END}")

def test_cupy_features(cp, device_name: str):
    """Testa funcionalidades espec√≠ficas do CuPy"""
    print_header(f"TESTE DE FUNCIONALIDADES - {device_name}")
    
    tests = [
        ("Array Creation", lambda: cp.array([1, 2, 3, 4, 5])),
        ("Random Generation", lambda: cp.random.random((100, 100))),
        ("Mathematical Operations", lambda: cp.sin(cp.linspace(0, cp.pi, 1000))),
        ("Matrix Operations", lambda: cp.linalg.inv(cp.random.random((50, 50)))),
        ("FFT Operations", lambda: cp.fft.fft(cp.random.random(1024))),
=======
    """Teste de performance GPU"""
    print(f"\n{Colors.GREEN}‚ö° TESTE GPU - Matriz {size}x{size}{Colors.END}")
    
    start_time = time.time()
    
    # Opera√ß√µes CuPy (GPU)
    a_gpu = cp.random.random((size, size), dtype=cp.float32)
    b_gpu = cp.random.random((size, size), dtype=cp.float32)
    
    # Multiplica√ß√£o de matrizes
    c_gpu = cp.dot(a_gpu, b_gpu)
    
    # Opera√ß√µes estat√≠sticas
    mean_val = float(cp.mean(c_gpu))
    std_val = float(cp.std(c_gpu))
    sum_val = float(cp.sum(c_gpu))
    
    # Sincronizar para garantir que todas as opera√ß√µes GPU terminaram
    cp.cuda.Stream.null.synchronize()
    
    end_time = time.time()
    gpu_time = end_time - start_time
    
    print(f"   üìä Resultado: m√©dia={mean_val:.4f}, std={std_val:.4f}")
    print(f"   ‚ö° Tempo GPU: {Colors.BOLD}{gpu_time:.4f} segundos{Colors.END}")
    
    return gpu_time, mean_val

def compare_performance(cpu_time: float, gpu_time: float):
    """Compara performance entre CPU e GPU"""
    print_header("COMPARA√á√ÉO DE PERFORMANCE")
    
    print(f"{Colors.BLUE}üñ•Ô∏è  CPU: {cpu_time:.4f} segundos{Colors.END}")
    print(f"{Colors.GREEN}‚ö° GPU: {gpu_time:.4f} segundos{Colors.END}")
    
    if gpu_time > 0:
        speedup = cpu_time / gpu_time
        if speedup > 1:
            print(f"\n{Colors.BOLD}{Colors.GREEN}üöÄ GPU √© {speedup:.2f}x MAIS R√ÅPIDO!{Colors.END}")
        else:
            print(f"\n{Colors.YELLOW}‚ö†Ô∏è  CPU foi {1/speedup:.2f}x mais r√°pido (matriz pequena demais ou overhead GPU){Colors.END}")
    else:
        print(f"\n{Colors.RED}‚ùå N√£o foi poss√≠vel calcular speedup{Colors.END}")

def test_cupy_features(cp, device_name: str):
    """Testa recursos espec√≠ficos do CuPy"""
    print_header(f"TESTE DE RECURSOS - {device_name}")
    
    tests = [
        ("Cria√ß√£o de Array", lambda: cp.array([1, 2, 3, 4, 5])),
        ("Opera√ß√µes Matem√°ticas", lambda: cp.sqrt(cp.array([1, 4, 9, 16, 25]))),
        ("Random Numbers", lambda: cp.random.random(1000)),
        ("FFT", lambda: cp.fft.fft(cp.random.random(1024))),
        ("Linear Algebra", lambda: cp.linalg.inv(cp.eye(100))),
>>>>>>> 3f8bd3ee87 (Add new processing scripts and documentation)
    ]
    
    for test_name, test_func in tests:
        try:
            start_time = time.time()
            result = test_func()
            end_time = time.time()
<<<<<<< HEAD
            print_status(test_name, "OK", f"{end_time-start_time:.4f}s")
        except Exception as e:
            print_status(test_name, "ERRO", str(e)[:50])

def memory_transfer_test(cp):
    """Testa transfer√™ncia de mem√≥ria CPU-GPU"""
    print_header("TESTE DE TRANSFER√äNCIA DE MEM√ìRIA")
    
    sizes = [1000, 5000, 10000]
    
    for size in sizes:
        print(f"\nTamanho da matriz: {size}x{size}")
        
        # Criar dados na CPU
        cpu_data = np.random.random((size, size)).astype(np.float32)
        
        # CPU -> GPU
        start_time = time.time()
        gpu_data = cp.asarray(cpu_data)
        transfer_to_gpu_time = time.time() - start_time
        
        # GPU -> CPU
        start_time = time.time()
        result_cpu = cp.asnumpy(gpu_data)
        transfer_to_cpu_time = time.time() - start_time
        
        print(f"  CPU->GPU: {transfer_to_gpu_time:.4f}s")
        print(f"  GPU->CPU: {transfer_to_cpu_time:.4f}s")
        print(f"  Total: {transfer_to_gpu_time + transfer_to_cpu_time:.4f}s")

def main():
    """Fun√ß√£o principal"""
    print_header("TESTE COMPLETO DE GPU - ALZHEIMER PIPELINE")
    print(f"{Colors.CYAN}Verifica√ß√£o completa de capacidade GPU para processamento neuroimagem{Colors.END}")
    
    # 1. Teste de disponibilidade da GPU
    gpu_available, cp = test_gpu_availability()
    
    if not gpu_available:
        print(f"\n{Colors.RED}GPU n√£o dispon√≠vel. Pipeline ser√° executado na CPU.{Colors.END}")
        print(f"{Colors.YELLOW}Para melhor performance, considere:{Colors.END}")
        print("  - Instalar drivers NVIDIA")
        print("  - Instalar CUDA Toolkit")
        print("  - Instalar CuPy: pip install cupy-cuda12x")
        return
    
    # 2. Obter informa√ß√µes do dispositivo
    try:
        device_props = cp.cuda.runtime.getDeviceProperties(0)
        device_name = device_props['name'].decode()
    except:
        device_name = "GPU Desconhecida"
    
    # 3. Testes de performance
    print_header("TESTE DE PERFORMANCE - CPU vs GPU")
    
    # Teste diferentes tamanhos
    sizes = [1000, 3000, 5000]
    
    for size in sizes:
        print(f"\n{Colors.BOLD}MATRIZ {size}x{size}{Colors.END}")
        print("-" * 20)
        
        cpu_time, cpu_result = performance_test_cpu(size)
        gpu_time, gpu_result = performance_test_gpu(cp, size)
        
        compare_performance(cpu_time, gpu_time)
    
    # 4. Teste de funcionalidades
    test_cupy_features(cp, device_name)
    
    # 5. Teste de transfer√™ncia de mem√≥ria
    memory_transfer_test(cp)
    
    # 6. Resumo final
    print_header("RESUMO E RECOMENDA√á√ïES")
    
    print(f"{Colors.GREEN}GPU detectada e funcional: {device_name}{Colors.END}")
    print(f"{Colors.GREEN}CuPy instalado e operacional{Colors.END}")
    print(f"{Colors.GREEN}Todas as opera√ß√µes b√°sicas funcionando{Colors.END}")
    
    print(f"\n{Colors.CYAN}RECOMENDA√á√ïES PARA O PIPELINE:{Colors.END}")
    print("  - Use force_gpu=True nos scripts de an√°lise")
    print("  - Configure batch_size >= 64 para melhor performance")
    print("  - Use mixed precision para economizar mem√≥ria")
    print("  - Monitore uso de mem√≥ria GPU durante execu√ß√£o")
    
    print(f"\n{Colors.BOLD}PR√ìXIMOS PASSOS:{Colors.END}")
    print("  1. Execute: python3 alzheimer_ai_pipeline.py")
    print("  2. Execute: python3 analisar_hipocampo_gpu_otimizado.py")
    print("  3. Monitor TensorBoard: tensorboard --logdir=logs")
=======
            
            print_status(test_name, "‚úÖ OK", f"{end_time-start_time:.4f}s")
        except Exception as e:
            print_status(test_name, "‚ùå ERRO", str(e)[:50])

def memory_transfer_test(cp):
    """Testa transfer√™ncia de mem√≥ria GPU ‚Üî CPU"""
    print_header("TESTE DE TRANSFER√äNCIA DE MEM√ìRIA")
    
    size = (2000, 2000)
    
    # CPU ‚Üí GPU
    print(f"{Colors.CYAN}üì§ Transferindo dados CPU ‚Üí GPU...{Colors.END}")
    start_time = time.time()
    cpu_array = np.random.random(size).astype(np.float32)
    gpu_array = cp.asarray(cpu_array)
    cp.cuda.Stream.null.synchronize()
    transfer_to_gpu_time = time.time() - start_time
    print(f"   ‚è±Ô∏è  Tempo: {transfer_to_gpu_time:.4f} segundos")
    
    # GPU ‚Üí CPU  
    print(f"{Colors.CYAN}üì• Transferindo dados GPU ‚Üí CPU...{Colors.END}")
    start_time = time.time()
    result_cpu = cp.asnumpy(gpu_array)
    transfer_to_cpu_time = time.time() - start_time
    print(f"   ‚è±Ô∏è  Tempo: {transfer_to_cpu_time:.4f} segundos")
    
    # Verificar integridade
    if np.allclose(cpu_array, result_cpu):
        print_status("Integridade", "‚úÖ OK", "Dados transferidos corretamente")
    else:
        print_status("Integridade", "‚ùå ERRO", "Dados corrompidos na transfer√™ncia")

def main():
    """Fun√ß√£o principal"""
    print(f"{Colors.BOLD}{Colors.PURPLE}")
    print("üß™ TESTE COMPLETO DE GPU vs CPU")
    print("=" * 60)
    print("NVIDIA RTX A4000 | Ubuntu 24.04 | CUDA 12.9")
    print("=" * 60)
    print(f"{Colors.END}")
    
    # Teste de disponibilidade da GPU
    gpu_available, cp, device_name = test_gpu_availability()
    
    if gpu_available:
        print(f"\n{Colors.GREEN}‚úÖ GPU DISPON√çVEL E FUNCIONANDO!{Colors.END}")
        
        # Testes de recursos
        test_cupy_features(cp, device_name)
        
        # Teste de transfer√™ncia de mem√≥ria
        memory_transfer_test(cp)
        
        # Teste de performance
        print_header("BENCHMARK DE PERFORMANCE")
        
        sizes = [1000, 3000, 5000]
        for size in sizes:
            print(f"\n{Colors.BOLD}üìè Testando matrizes {size}x{size}...{Colors.END}")
            
            cpu_time, cpu_result = performance_test_cpu(size)
            gpu_time, gpu_result = performance_test_gpu(cp, size)
            
            compare_performance(cpu_time, gpu_time)
            
        print_header("RESUMO FINAL")
        print(f"{Colors.BOLD}{Colors.GREEN}‚úÖ GPU est√° funcionando perfeitamente!{Colors.END}")
        print(f"{Colors.WHITE}üìã Para usar GPU em seus scripts Python:{Colors.END}")
        print(f"{Colors.CYAN}   import cupy as cp{Colors.END}")
        print(f"{Colors.CYAN}   array_gpu = cp.array([1, 2, 3])  # Array na GPU{Colors.END}")
        print(f"{Colors.CYAN}   result = cp.sum(array_gpu)       # Processamento na GPU{Colors.END}")
        
    else:
        print(f"\n{Colors.RED}‚ùå GPU N√ÉO EST√Å FUNCIONANDO{Colors.END}")
        print(f"{Colors.YELLOW}üí° Solu√ß√µes poss√≠veis:{Colors.END}")
        print(f"   1. Reiniciar o sistema para carregar novos drivers")
        print(f"   2. Verificar se CUDA 12.9 est√° no PATH")
        print(f"   3. Reinstalar drivers: sudo apt install nvidia-open")
        
        # Teste s√≥ CPU
        print_header("TESTE APENAS CPU")
        cpu_time, cpu_result = performance_test_cpu(3000)
        print(f"{Colors.BLUE}üñ•Ô∏è  CPU funcionando normalmente{Colors.END}")
>>>>>>> 3f8bd3ee87 (Add new processing scripts and documentation)

if __name__ == "__main__":
    main() 